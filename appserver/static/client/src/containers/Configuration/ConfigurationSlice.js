import { createAsyncThunk, createSlice, isAnyOf } from '@reduxjs/toolkit'
import { splunkdPath } from '@splunk/splunk-utils/config'

export const fetchProxy = createAsyncThunk('fetchProxy', () => {
  try {
    return fetch(
      `${splunkdPath}/servicesNS/nobody/tg-05-splunk-add-on/TA_cisco_threat_grid_settings/proxy?output_mode=json`,
      { method: 'GET' }
    ).then((response) => response.json())
  } catch (e) {
    console.error(e)
  }
})

export const fetchLogging = createAsyncThunk('fetchLogging', () => {
  try {
    return fetch(
      `${splunkdPath}/servicesNS/nobody/tg-05-splunk-add-on/TA_cisco_threat_grid_settings/logging?output_mode=json`,
      { method: 'GET' }
    ).then((response) => response.json())
  } catch (e) {
    console.error(e)
  }
})

const initialState = {
  proxy: {},
  logging: {},
  pending: false
}

export const configurationSlice = createSlice({
  name: 'configuration',
  initialState,
  extraReducers: async (builder) => {
    builder.addMatcher(
      isAnyOf(fetchProxy.pending, fetchLogging.pending),
      (state) => {
        state.pending = true
      }
    )
    builder.addCase(fetchProxy.fulfilled, (state, { payload }) => {
      state.proxy = payload.entry[0]
      state.pending = false
    })
    builder.addCase(fetchLogging.fulfilled, (state, { payload }) => {
      state.logging = payload.entry[0]
      state.pending = false
    })
  }
})

export default configurationSlice.reducer
