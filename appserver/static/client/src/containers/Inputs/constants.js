import * as yup from 'yup'
import { omit } from 'lodash'

import { createInput, deleteInput, editInput } from './InputsSlice'
import {
  ADD_MODAL_SUBMIT_BUTTON,
  CLONE_MODAL_SUBMIT_BUTTON,
  DELETE_MODAL_SUBMIT_BUTTON,
  EDIT_MODAL_SUBMIT_BUTTON,
  MODAL_CANCEL_BUTTON
} from '../../constants'

export const INPUTS_DESCRIPTION = 'Manage your data inputs'

export const CREATE_INPUT_BUTTON_TEXT = 'Create New Search'

export const NAME_COLUMN_TITLE = 'Name'
export const INTERVAL_COLUMN_TITLE = 'Interval'
export const INDEX_COLUMN_TITLE = 'Index'
export const STATUS_COLUMN_TITLE = 'Status'

export const TABLE_SORT_FUNCTIONS = {
  [NAME_COLUMN_TITLE]: (array) => array.sort((a, b) => a.content.name - b.content.name),
  [INTERVAL_COLUMN_TITLE]: (array) => array.sort((a, b) => a.content.interval - b.interval),
  [INDEX_COLUMN_TITLE]: (array) => array.sort((a, b) => a.content.index - b.content.index),
  [STATUS_COLUMN_TITLE]: (array) => array.sort((a, b) => a.content.disabled - b.content.disabled),
}

export const HEADER_COLUMN_TITLES = [
  NAME_COLUMN_TITLE,
  INTERVAL_COLUMN_TITLE,
  INDEX_COLUMN_TITLE,
  STATUS_COLUMN_TITLE
]

export const CREATE_INPUT_MODAL = 'Add Cisco Secure Malware Analytics'
export const EDIT_INPUT_MODAL = 'Update Cisco Secure Malware Analytics'
export const CLONE_INPUT_MODAL = 'Clone Cisco Secure Malware Analytics'
export const DELETE_INPUT_MODAL = 'Delete Confirmation'

export const getCreateInputValidationSchema = (inputNames, isEdit) => {
  const schema = {
    name: yup
      .string()
      .required('The name is required.')
      .notOneOf(inputNames, 'Name is already in use.')
      .matches(/^[A-Za-z][A-Za-z0-9_]*$/, 'Input Name must start with a letter and followed by alphabetic letters, digits or underscores'),
    interval: yup.string().required('The interval is required.'),
    index: yup.string().required('The Index is required.'),
    after: yup.string().required('The After field is required.'),
    global_account: yup.string().required('The Account is required.')
  }

  return yup.object().shape(isEdit ? omit(schema, ['name']) : schema)
}

export const getCreateInputFields = ({ options, disableName, accounts }) => ([
  {
    name: 'name',
    label: 'Name',
    helpText: 'Enter a unique name for the data input',
    disabled: disableName
  },
  {
    name: 'interval',
    label: 'Interval',
    helpText: 'Time interval in seconds between API queries. Should be set to 300.'
  },
  {
    name: 'index',
    label: 'Index',
    as: 'select',
    options: [{ view: 'default', value: 'default' }, ...options]
  },
  {
    name: 'after',
    label: 'After',
    helpText: 'The initial after value used when querying the Threat Grid API. Should be 10 minutes ago.'
  },
  {
    name: 'global_account',
    label: 'Global Account',
    as: 'select',
    options: [{ value: 'default', disabled: true, hidden: true, view: 'Select an option' }, ...accounts]
  }
])

export const getCreateInputModalVerbiage = ({ dispatch, options, inputNames, accounts }) => ({
  title: CREATE_INPUT_MODAL,
  formProps: {
    validationSchema: getCreateInputValidationSchema(inputNames),
    fields: getCreateInputFields({ options, accounts }),
    onSubmit: values => dispatch(createInput(values)),
    initialValues: {
      name: '',
      interval: 300,
      index: 'default',
      after: '10 minutes ago',
      global_account: 'default'
    }
  },
  cancel: MODAL_CANCEL_BUTTON,
  submit: ADD_MODAL_SUBMIT_BUTTON
})

export const getEditInputModalVerbiage = ({
  dispatch,
  options,
  inputNames,
  accounts,
  input: {
    name,
    content: {
      interval,
      index,
      after,
      global_account
    }
  } }) => ({
  title: EDIT_INPUT_MODAL,
  formProps: {
    validationSchema: getCreateInputValidationSchema(inputNames, true),
    fields: getCreateInputFields({ options, disableName: true, accounts }),
    onSubmit: values => dispatch(editInput(values)),
    initialValues: {
      name,
      interval,
      index,
      after,
      global_account
    }
  },
  cancel: MODAL_CANCEL_BUTTON,
  submit: EDIT_MODAL_SUBMIT_BUTTON
})

export const getCloneInputModalVerbiage = ({
  dispatch,
  options,
  inputNames,
  accounts,
  input: {
    content: {
      interval,
      index,
      after,
      global_account
    }
  } }) => ({
  title: CLONE_INPUT_MODAL,
  formProps: {
    validationSchema: getCreateInputValidationSchema(inputNames),
    fields: getCreateInputFields({ options, accounts }),
    onSubmit: values => dispatch(createInput(values)),
    initialValues: {
      name: '',
      interval,
      index,
      after,
      global_account
    }
  },
  cancel: MODAL_CANCEL_BUTTON,
  submit: CLONE_MODAL_SUBMIT_BUTTON
})

export const getDeleteInputModalVerbiage = ({ dispatch, input }) => ({
  title: DELETE_INPUT_MODAL,
  cancel: MODAL_CANCEL_BUTTON,
  submit: DELETE_MODAL_SUBMIT_BUTTON,
  body: `Are you sure you want to delete "${input.name}" ?`,
  submitModal: () => dispatch(deleteInput(input))
})
