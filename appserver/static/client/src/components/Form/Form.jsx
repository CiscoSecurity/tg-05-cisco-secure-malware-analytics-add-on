import cx from 'classnames'
import PropTypes from 'prop-types'
import React, { forwardRef } from 'react'
import { Field, Formik, Form as FormikForm } from 'formik'
import { isEmpty } from 'lodash'

import { Stop } from '../Icons/Icons'

import styles from './Form.module.scss'

const Input = ({ field, ...props }) => (
  <input {...field} {...props} className="input" />
)

Input.propTypes = {
  field: PropTypes.object
}

const Checkbox = ({ field, ...props }) => (
  <label className={cx(styles.checkbox, 'checkbox')}>
    <input type="checkbox" className="checkbox__input" {...field} {...props}/>
    <div className="checkbox__box"></div>
    <div className="checkbox__label">{props.checkboxLabel}</div>
  </label>
)

Checkbox.propTypes = {
  checkboxLabel: PropTypes.string,
  field: {
    value: PropTypes.string || PropTypes.bool
  }
}

const Form = forwardRef(({
  initialValues,
  onSubmit,
  fields,
  validationSchema,
  validate,
  setDisableSubmit
}, ref) => {
  return (
    <Formik
      validate={validate}
      initialValues={initialValues}
      onSubmit={onSubmit}
      validationSchema={validationSchema}
    >
      {({ isSubmitting, submitForm, errors }) => {
        if (ref) ref.current = { submitForm }
        setDisableSubmit(isSubmitting || !isEmpty(errors))

        return (
          <FormikForm>
            <div className="form-group">
              {fields?.map(({ type, name, label, as, helpText, options, ...props }) => (
                <div className={cx(styles.formGroup, 'form-group__text')} key={name}>
                  {label &&
                    <label className={cx(styles.label, 'label')} htmlFor={name}>{label}</label>
                  }
                  {as === 'select'
                    ? (
                      <Field type={name} name={name} as={as}>
                        {options.map(({ value, view, disabled, hidden }) => (
                          <option
                            disabled={disabled}
                            hidden={hidden}
                            key={value}
                            value={value}
                          >
                            {view}
                          </option>
                        ))}
                      </Field>
                    )
                    : type === 'checkbox'
                      ? <Field {...props} label={label} type={type || name} name={name} as={as || 'input'} component={Checkbox}/>
                      : <Field {...props} type={type || name} name={name} as={as || 'input'} component={Input}/>
                  }
                  <div className={cx(styles.helpBlock, 'help-block')}>
                    {errors[name] && <Stop />}
                    <span className={cx(
                      'help-block__text',
                      errors[name] && 'help-block__text--state-danger'
                    )}>
                      {errors[name] || helpText}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </FormikForm>
        )
      }}
    </Formik>
  )
})

Form.propTypes = {
  initialValues: PropTypes.object.isRequired,
  validationSchema: PropTypes.object,
  validate: PropTypes.func,
  onSubmit: PropTypes.func.isRequired,
  fields: PropTypes.arrayOf(PropTypes.shape({
    type: PropTypes.string.isRequired,
    as: PropTypes.string,
    label: PropTypes.string
  })).isRequired,
  submitText: PropTypes.string,
  setDisableSubmit: PropTypes.func
}

Form.displayName = 'Form'

export default Form
